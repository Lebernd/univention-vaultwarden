#!/bin/bash

eval "$(ucr shell)"

CONFIG="$(univention-app shell bitwarden-rs cat /etc/univention/base.conf)"
DATADIR="/var/lib/bitwarden_rs"

CONFIG_HOSTNAME="$(echo "$CONFIG" | sed -n 's/^bitwarden-rs\/hostname: \(.*\)/\1/p')"
if [ -z ${CONFIG_HOSTNAME} ]; then
	# use default hostname if CONFIG_HOSTNAME is not set
	echo "setting default hostname"
	HOST="https://${hostname}.${domainname}:8678/"
	ServerName="${hostname}.${domainname}"
	Ports="Listen 8567
Listen 8678"
	VirtualHostHTTP="*:8567"
	VirtualHostSSL="*:8678"
else
	echo "using custom hostname"
	HOST="https://$CONFIG_HOSTNAME/"
	ServerName="$CONFIG_HOSTNAME"
	Ports=""
	VirtualHostHTTP="*:80"
	VirtualHostSSL="*:443"
fi

CONFIG_SSLCERTIFICATE="$(echo "$CONFIG" | sed -n 's/^bitwarden-rs\/sslcertificate: \(.*\)/\1/p')"
if [ ! -z ${CONFIG_SSLCERTIFICATE} ] && [ -f ${CONFIG_SSLCERTIFICATE} ]; then
	echo "using custom certificate"
	SSLCERTIFICATE="$CONFIG_SSLCERTIFICATE"
elif [ ! -z $(ucr get apache2/ssl/certificate) ]; then
	echo "using ucr defined certificate"
	SSLCERTIFICATE=$(ucr get apache2/ssl/certificate)
else
	echo "using ucs default certificate"
	SSLCERTIFICATE="/etc/univention/ssl/${hostname}.${domainname}/cert.pem"
fi

CONFIG_SSLKEY="$(echo "$CONFIG" | sed -n 's/^bitwarden-rs\/sslkey: \(.*\)/\1/p')"
if [ ! -z ${CONFIG_SSLKEY} ] && [ -f ${CONFIG_SSLKEY} ]; then
	echo "using custom private key"
	SSLKEY="$CONFIG_SSLKEY"
elif [ ! -z $(ucr get apache2/ssl/key) ]; then
	echo "using ucr defined private key"
	SSLKEY=$(ucr get apache2/ssl/key)
else
	echo "using ucs default privat key"
	SSLKEY="/etc/univention/ssl/${hostname}.${domainname}/private.key"
fi

CONFIG_SSLCA="$(echo "$CONFIG" | sed -n 's/^bitwarden-rs\/sslca: \(.*\)/\1/p')"
if [ ! -z ${CONFIG_SSLCA} ] && [ -f ${CONFIG_SSLCA} ]; then
	echo "using custom ca"
	SSLCA="$CONFIG_SSLCA"
elif [ ! -z $(ucr get apache2/ssl/ca) ]; then
	echo "using ucr defined ca"
	SSLCA=$(ucr get apache2/ssl/ca)
else
	echo "using ucs default ca"
	SSLCA="/etc/univention/ssl/ucsCA/CAcert.pem"
fi

CONFIG_SSLCHAIN="$(echo "$CONFIG" | sed -n 's/^bitwarden-rs\/sslchain: \(.*\)/\1/p')"
if [ ! -z ${CONFIG_SSLCHAIN} ] && [ -f ${CONFIG_SSLHAIN} ]; then
	echo "using custom chain"
	SSLCHAIN="SSLCertificateChainFile $CONFIG_SSLCHAIN"
elif [ ! -z $(ucr get apache2/ssl/certificatechain) ]; then
	echo "using ucr defined chain"
	SSLCHAIN="SSLCertificateChainFile $(ucr get apache2/ssl/certificatechain)"
fi

cat <<-EOF >"/etc/apache2/sites-available/bitwarden_rs.conf"

###################################################################
# generated by bitwarden_rs app join script, do not edit manually #
###################################################################

${Ports}

<VirtualHost ${VirtualHostHTTP}>
        ServerName ${ServerName}
        ServerAdmin webmaster@example.org

        ErrorLog \${APACHE_LOG_DIR}/mattermost-error.log
        CustomLog \${APACHE_LOG_DIR}/mattermost-access.log combined

        # Enforce HTTPS:
        RewriteEngine On
        RewriteCond %{REQUEST_URI} !^/.well-known/acme-challenge/
        RewriteCond %{HTTPS} !=on
        RewriteRule ^/?(.*) $HOST\$1 [R,L]
</VirtualHost>

<VirtualHost ${VirtualHostSSL}>
        SSLEngine on
        ServerName ${ServerName}
        ServerAdmin webmaster@example.org

        SSLCertificateFile ${SSLCERTIFICATE}
        SSLCertificateKeyFile ${SSLKEY}
        SSLCACertificateFile ${SSLCA}
	${SSLCHAIN}

        ErrorLog \${APACHE_LOG_DIR}/bitwarden_rs-error.log
        CustomLog \${APACHE_LOG_DIR}/bitwarden_rs-access.log combined

        <Location />
                Require all granted
                ProxyPass http://127.0.0.1:9080/
                ProxyPassReverse http://127.0.0.1:9080/
        </Location>

        ProxyPreserveHost On
        ProxyRequests Off
</VirtualHost>

EOF

cat <<-EOF >"/etc/apache2/ucs-sites.conf.d/bitwarden_rs.conf"

###################################################################
# generated by bitwarden_rs app join script, do not edit manually #
###################################################################

Redirect 303 /bitwarden_rs ${HOST}
EOF

a2ensite bitwarden_rs
invoke-rc.d apache2 reload
